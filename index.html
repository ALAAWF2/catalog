<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>جدول البضاعة</title>
  <style>
    body { font-family: Arial; background: #fff8f0; padding: 20px; }
    h1 { text-align: center; color: #e67e22; }
    select, button, input[type='number'], input[type='text'] {
      margin: 5px; padding: 8px; font-size: 14px; border-radius: 5px; border: 1px solid #ccc;
    }
    .filters { text-align: center; margin-bottom: 20px; }
    .products { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
    .product { background: white; padding: 15px; border-radius: 10px; border: 1px solid #f0c79b; box-shadow: 0 2px 5px rgba(230, 126, 34, 0.1); text-align: center; }
    .product img { width: 100%; height: 150px; object-fit: contain; margin-bottom: 10px; border-radius: 8px; background-color: #fff0e0; }
    .pagination { text-align: center; margin-top: 20px; }
    .pagination button, .pagination select { margin: 5px; padding: 8px 16px; background: #e67e22; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .pagination button:disabled { background: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>
  <h1>جدول البضاعة</h1>

  <div class="filters">
    <label>اختر المستودع:
      <select id="warehouseFilter"></select>
    </label>
    <label>اختر التصنيف:
      <select id="categoryFilter"></select>
    </label>
    <input type="text" id="searchInput" placeholder="ابحث بالـ Alias..." oninput="renderProducts()" />
    <button onclick="openOrderModal()">ارسال الطلبية</button>
  </div>

  <div class="products" id="productContainer"></div>
  <div class="pagination" id="pagination"></div>

  <div id="orderModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
    <div style="background:white; padding:20px; border-radius:10px; text-align:center;">
      <h3>اختر المعرض</h3>
      <select id="mallSelect"></select><br><br>
      <button onclick="submitOrder()">تأكيد الطلبية</button>
      <button onclick="closeOrderModal()" style="background:grey;">إلغاء</button>
    </div>
  </div>

  <script src="products.js"></script>
  <script>
    const warehouseFilter = document.getElementById('warehouseFilter');
    const categoryFilter = document.getElementById('categoryFilter');
    const productContainer = document.getElementById('productContainer');
    const pagination = document.getElementById('pagination');
    const mallSelect = document.getElementById('mallSelect');

    let filteredProducts = [];
    let currentPage = 1;
    const productsPerPage = 40;
    const cart = {};

    const mallNames = ["04-Andalos Mall", "05-Haifa Mall", "06-Red Sea Mall", "07-Arab Mall", "08-Makkah Mall", "09-Al-Salam Mall"];

    function populateFilters() {
      const outlets = [...new Set(data.map(d => d.outlet))];
      const categories = [...new Set(data.map(d => d.category))];

      warehouseFilter.innerHTML = '<option value="">الكل</option>' + outlets.map(o => `<option value="${o}">${o}</option>`).join('');
      categoryFilter.innerHTML = '<option value="">الكل</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');
    }

   function renderProducts() {
  const outlet = warehouseFilter.value;
  const category = categoryFilter.value;
  const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();

  if (!outlet) {
    productContainer.innerHTML = "<h3 style='text-align:center;'>يرجى اختيار مستودع لعرض المنتجات</h3>";
    pagination.innerHTML = '';
    return;
  }

  filteredProducts = data.filter(d =>
    d.stock > 20 &&
    (!outlet || d.outlet === outlet) &&
    (!category || d.category === category) &&
    (!searchTerm || (d.alias && d.alias.toString().toLowerCase().includes(searchTerm)))
  );

  renderPage(1);
}

    function renderPage(page) {
      currentPage = page;
      const start = (page - 1) * productsPerPage;
      const end = start + productsPerPage;
      const productsToShow = filteredProducts.slice(start, end);

      productContainer.innerHTML = productsToShow.map(d => `
        <div class="product">
          <img src="images/${d.code}.jpg" alt="${d.name}" onerror="this.src='noimage.png'">
          <h4>${d.name}</h4>
          <p>السعر: ${d.price} ريال</p>
          <p><strong>الكود:</strong> ${d.code}</p>
          <p><strong>Alias:</strong> ${d.alias ?? '—'}</p>
          <p>الكمية المتوفرة: ${d.stock}</p>
          <input type="number" min="1" placeholder="الكمية المطلوبة" onchange="addToCart('${d.code}', '${d.name}', this.value)">
        </div>
      `).join('');

      renderPagination();
    }

    function renderPagination() {
      const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
      let options = '';
      for (let i = 1; i <= totalPages; i++) {
        options += `<option value="${i}" ${i === currentPage ? 'selected' : ''}>${i}</option>`;
      }
      pagination.innerHTML = `
        <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>السابق</button>
        اختر صفحة <select onchange="goToPage(this.value)">${options}</select>
        <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>التالي</button>
      `;
    }

    function changePage(page) {
      if (page > 0 && page <= Math.ceil(filteredProducts.length / productsPerPage)) {
        renderPage(page);
      }
    }

    function goToPage(page) {
      renderPage(Number(page));
    }

    function addToCart(code, name, qty) {
      if (qty && parseInt(qty) > 0) cart[code] = { name, qty };
      else delete cart[code];
    }

    function openOrderModal() {
      mallSelect.innerHTML = mallNames.map(m => `<option value="${m}">${m}</option>`).join('');
      document.getElementById('orderModal').style.display = 'flex';
    }

    function closeOrderModal() {
      document.getElementById('orderModal').style.display = 'none';
    }

    function submitOrder() {
      const mallName = mallSelect.value;
      if (!mallName) {
        alert("يرجى اختيار معرض صحيح!");
        return;
      }
      closeOrderModal();
      alert("تم إرسال الطلبية بنجاح (محاكاة)");
      // هنا يمكنك لاحقاً إضافة كود إرسال الطلبية الحقيقي
    }

    warehouseFilter.addEventListener('change', renderProducts);
    categoryFilter.addEventListener('change', renderProducts);

    populateFilters();
    renderProducts();
  </script>
</body>
</html>
